<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Artists</title>
<style>
body { font-family: Arial; margin: 0; background: #f5f5f5; }
header { background: #111; color: white; padding: 15px; }
nav a { color: white; margin-right: 15px; text-decoration: none; font-weight: bold; }
main { padding: 20px; }
input { width: 100%; padding: 10px; font-size: 16px; margin-bottom: 20px; }
.grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap: 20px; }
.card { background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,.1); }
.card img { width: 100%; border-radius: 4px; }
.stars { display: flex; gap: 5px; cursor: pointer; margin-top: 8px; }
.star { font-size: 22px; color: #ccc; }
.star.active { color: gold; }
.average { font-size: 14px; margin-top: 4px; color: #555; }
</style>
</head>
<body>
<header>
<h1>Artists</h1>
<nav>
<a href="index.html">Home</a>
<a href="albums.html">Albums</a>
<a href="songs.html">Songs</a>
<a href="artists.html">Artists</a>
</nav>
</header>

<main>
<input id="search" placeholder="Search artists...">
<div class="grid" id="grid"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUoxl-FUxfUbc7sEIGxHCPUgyiWIXLs6o",
  authDomain: "music-ranker-54f1a.firebaseapp.com",
  databaseURL: "https://music-ranker-54f1a-default-rtdb.firebaseio.com",
  projectId: "music-ranker-54f1a",
  storageBucket: "music-ranker-54f1a.firebasestorage.app",
  messagingSenderId: "238695800458",
  appId: "1:238695800458:web:b98d744977f3761e9ed773"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
signInAnonymously(auth);

const grid = document.getElementById("grid");
let data = [];

fetch("artists.json").then(r => r.json()).then(d => { data = d; render(d); });

function render(items){
  grid.innerHTML = "";
  items.forEach(a => {
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <img src="${a.image}">
      <h3>${a.name}</h3>
      <p>Debut: ${a.debut}</p>
      <div class="rating" data-id="${a.id}">
        <div class="stars">${"★".repeat(5).split("").map(()=>`<span class="star">★</span>`).join("")}</div>
        <div class="average">Average: —</div>
      </div>`;
    grid.appendChild(c);
  });
  initRatings("artists");
}

function filterItems(){
  const q = document.getElementById("search").value.toLowerCase();
  render(data.filter(x => x.name.toLowerCase().includes(q)));
}

// attach search input listener
document.getElementById("search").addEventListener("keyup", () => filterItems());

function initRatings(type){
  onAuthStateChanged(auth,user=>{
    if(!user) return;
    document.querySelectorAll(".rating").forEach(b=>{
      const id = String(b.dataset.id);
      const stars = b.querySelectorAll(".star");
      const avg = b.querySelector(".average");
      const base = ref(db,`ratings/${type}/${id}`);
      const userRef = ref(db,`ratings/${type}/${id}/userRatings/${user.uid}`);

      onValue(base,s=>{
        const d = s.val();
        if(!d||!d.userRatings){ avg.textContent="Average: —"; return; }
        const v = Object.values(d.userRatings);
        avg.textContent = `Average: ${(v.reduce((a,b)=>a+b,0)/v.length).toFixed(2)} (${v.length})`;
      });

      get(userRef).then(s=>{ if(s.exists()) highlight(stars,s.val()); });

      stars.forEach((st,i)=>st.onclick=()=>{ set(userRef,i+1); highlight(stars,i+1); });
    });
  });
}

function highlight(stars,r){ stars.forEach((s,i)=>s.classList.toggle("active",i<r)); }
</script>
</body>
</html>
